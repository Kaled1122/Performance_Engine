<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Performance Engine — Teacher Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #f5f5f7;
      color: #1d1d1f;
      padding: 40px;
    }
    .card {
      background: #fff;
      border-radius: 24px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.08);
      padding: 32px;
      max-width: 960px;
      margin: 0 auto;
    }
    .btn-primary {
      background: #0071e3;
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      transition: 0.2s;
    }
    .btn-primary:hover {
      background: #0077ed;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      font-size: 14px;
    }
    th, td {
      border-bottom: 1px solid #e5e5e5;
      padding: 10px 8px;
      text-align: left;
    }
    th {
      background: #fafafa;
      font-weight: 600;
    }
    .input-field {
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 10px;
      width: 100%;
      background-color: #fafafa;
      transition: border-color 0.2s;
    }
    .input-field:focus {
      outline: none;
      border-color: #0071e3;
      background-color: white;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1 class="text-3xl font-bold text-center mb-8">Performance Engine Dashboard</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="font-semibold">Learner ID</label>
        <input id="learner_id" type="text" placeholder="e.g., 461033" class="input-field">
      </div>

      <div>
        <label class="font-semibold">Lesson</label>
        <input id="lesson" type="text" placeholder="e.g., Lesson 2 — Polite Introductions" class="input-field">
      </div>

      <div>
        <label class="font-semibold">Domain</label>
        <select id="domain" class="input-field">
          <option value="Understanding">Understanding</option>
          <option value="Application">Application</option>
          <option value="Communication">Communication</option>
          <option value="Behavior">Behavior</option>
        </select>
      </div>

      <div>
        <label class="font-semibold">Score (0–100)</label>
        <input id="score" type="number" min="0" max="100" class="input-field">
      </div>
    </div>

    <div class="text-center mt-6">
      <button id="submitBtn" class="btn-primary">Submit Score</button>
    </div>

    <p id="status" class="text-center text-sm mt-3"></p>

    <hr class="my-8">

    <h2 class="text-2xl font-semibold mb-4">Learner Performance Records</h2>
    <div id="scoresTableContainer" class="overflow-x-auto">
      <table id="scoresTable">
        <thead>
          <tr>
            <th>Learner ID</th>
            <th>Domain</th>
            <th>Lesson</th>
            <th>Score</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const backendURL = "https://performanceengine-production.up.railway.app";
    const status = document.getElementById("status");
    const tableBody = document.querySelector("#scoresTable tbody");

    document.getElementById("submitBtn").addEventListener("click", async () => {
      const learner_id = document.getElementById("learner_id").value.trim();
      const domain = document.getElementById("domain").value;
      const lesson = document.getElementById("lesson").value.trim();
      const score = document.getElementById("score").value.trim();

      if (!learner_id || !domain || !lesson || !score) {
        status.textContent = "⚠️ Please fill in all fields.";
        status.style.color = "red";
        return;
      }

      try {
        const res = await fetch(`${backendURL}/update_score`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ learner_id, domain, lesson, score })
        });

        const data = await res.json();
        if (res.ok) {
          status.textContent = "✅ Score saved successfully!";
          status.style.color = "green";
          fetchScores(); // refresh table
        } else {
          status.textContent = "❌ " + (data.error || "Failed to save.");
          status.style.color = "red";
        }
      } catch (err) {
        console.error(err);
        status.textContent = "❌ Connection error.";
        status.style.color = "red";
      }
    });

    async function fetchScores() {
      tableBody.innerHTML = "<tr><td colspan='5' class='text-center py-3'>Loading...</td></tr>";
      try {
        const res = await fetch(`${backendURL}/get_scores`);
        const data = await res.json();

        if (!Array.isArray(data)) throw new Error("Invalid data");
        if (data.length === 0) {
          tableBody.innerHTML = "<tr><td colspan='5' class='text-center py-3 text-gray-500'>No scores yet</td></tr>";
          return;
        }

        tableBody.innerHTML = data.map(row => `
          <tr>
            <td>${row.learner_id}</td>
            <td>${row.domain}</td>
            <td>${row.lesson}</td>
            <td class="font-semibold">${row.score}</td>
            <td>${row.date}</td>
          </tr>
        `).join("");
      } catch (err) {
        console.error(err);
        tableBody.innerHTML = "<tr><td colspan='5' class='text-center py-3 text-red-500'>Failed to load scores</td></tr>";
      }
    }

    fetchScores();
  </script>
</body>
</html>
